
/**
 * MOCK Emscripten Module for 'CV Image Processor'
 * This simulates the interface that would be generated by 'emcc --bind'.
 * 
 * It implements a pure JS simple grayscale/edge effect to prove the pipeline works.
 */

var createCVModule = (function () {
    function Module(moduleArg) {
        this.HEAPU8 = new Uint8Array(0); // Simulate heap
        this.memory = { buffer: new ArrayBuffer(0) }; // Simulate memory

        // Simulate raw memory operations
        this._malloc = function (size) {
            if (this.HEAPU8.length < size) {
                // Resize "heap" if needed
                var newHeap = new Uint8Array(Math.max(this.HEAPU8.length * 2, size + 1024 * 1024));
                newHeap.set(this.HEAPU8);
                this.HEAPU8 = newHeap;
                this.memory.buffer = this.HEAPU8.buffer;
            }
            return 0; // Always return offset 0 for this simple mock
        };

        this._free = function (ptr) {
            // No-op for mock
        };

        // Bindings
        this.process_image = function (ptr, width, height) {
            console.log(`[MockWasm] Processing image: ${width}x${height}`);

            // Simulate C++ processing: RGBA -> Grayscale/Edge
            // Data is at HEAPU8[ptr] to HEAPU8[ptr + w*h*4]

            const start = ptr;
            const end = ptr + width * height * 4;
            const data = this.HEAPU8.subarray(start, end);

            for (let i = 0; i < data.length; i += 4) {
                // RGBA
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // Simple Gray
                const avg = 0.299 * r + 0.587 * g + 0.114 * b;

                // Simple "Edge-like" threshold to make it look processed
                // In real OpenCV Canny this is much more complex
                const val = avg > 128 ? 255 : 0;

                data[i] = val;   // R
                data[i + 1] = val; // G
                data[i + 2] = val; // B
                // Alpha unchanged
            }

            return true;
        };

        this.memory_get_offset = this._malloc;
        this.memory_free = this._free;

        // Async init simulation
        return Promise.resolve(this);
    }

    return Module;
})();
